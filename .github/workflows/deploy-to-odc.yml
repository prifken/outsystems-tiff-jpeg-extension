name: Deploy to OutSystems ODC

# Trigger workflow on push to main branch or manual trigger
on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: false
        default: 'Development'
        type: string

# Define environment variables used across jobs
env:
  DOTNET_VERSION: '8.0.x'
  PROJECT_FILE: 'ImageConverterLibrary.csproj'
  ARTIFACT_NAME: 'ImageConverterLibrary'
  ZIP_FILE: 'ImageConverterLibrary.zip'

jobs:
  # ============================================================================
  # BUILD JOB - Compile and package the external logic library
  # ============================================================================
  build:
    name: Build External Logic Library
    runs-on: windows-latest

    steps:
      # Step 1: Checkout the repository code
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better context

      # Step 2: Setup .NET SDK
      - name: Setup .NET ${{ env.DOTNET_VERSION }}
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      # Step 3: Display .NET version for debugging
      - name: Display .NET version
        run: dotnet --version

      # Step 4: Restore NuGet dependencies
      - name: Restore dependencies
        run: dotnet restore ${{ env.PROJECT_FILE }}

      # Step 5: Build the project in Release configuration
      - name: Build project
        run: dotnet build ${{ env.PROJECT_FILE }} --configuration Release --no-restore

      # Step 6: Publish the project for linux-x64 runtime (ODC Lambda target)
      - name: Publish project
        run: |
          dotnet publish ${{ env.PROJECT_FILE }} `
            --configuration Release `
            --runtime linux-x64 `
            --output ./publish `
            --no-build

      # Step 7: Create ZIP archive for ODC deployment
      - name: Create deployment package
        shell: pwsh
        run: |
          Write-Host "Creating ZIP archive from publish folder..."

          # Remove existing ZIP if present
          if (Test-Path ${{ env.ZIP_FILE }}) {
            Remove-Item ${{ env.ZIP_FILE }} -Force
            Write-Host "Removed existing ZIP file"
          }

          # Create new ZIP archive
          Compress-Archive -Path ./publish/* -DestinationPath ${{ env.ZIP_FILE }} -Force

          # Verify ZIP was created and show size
          if (Test-Path ${{ env.ZIP_FILE }}) {
            $zipSize = (Get-Item ${{ env.ZIP_FILE }}).Length / 1MB
            Write-Host "âœ… ZIP created successfully: ${{ env.ZIP_FILE }}"
            Write-Host "ðŸ“¦ Package size: $($zipSize.ToString('F2')) MB"
          } else {
            Write-Error "âŒ Failed to create ZIP file"
            exit 1
          }

      # Step 8: Upload ZIP artifact for deployment job
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ${{ env.ZIP_FILE }}
          retention-days: 30
          if-no-files-found: error

      # Step 9: Add build summary
      - name: Build summary
        shell: pwsh
        run: |
          Write-Output "## ðŸŽ‰ Build Successful" >> $env:GITHUB_STEP_SUMMARY
          Write-Output "" >> $env:GITHUB_STEP_SUMMARY
          Write-Output "**Project:** ${{ env.PROJECT_FILE }}" >> $env:GITHUB_STEP_SUMMARY
          Write-Output "**Configuration:** Release" >> $env:GITHUB_STEP_SUMMARY
          Write-Output "**Runtime:** linux-x64" >> $env:GITHUB_STEP_SUMMARY
          Write-Output "**Package:** ${{ env.ZIP_FILE }}" >> $env:GITHUB_STEP_SUMMARY
          Write-Output "" >> $env:GITHUB_STEP_SUMMARY
          Write-Output "âœ… Ready for deployment to ODC" >> $env:GITHUB_STEP_SUMMARY

  # ============================================================================
  # DEPLOY JOB - Upload library to OutSystems ODC
  # ============================================================================
  deploy:
    name: Deploy to ODC Development
    runs-on: windows-latest
    needs: build
    environment: development

    steps:
      # Step 1: Download the build artifact
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}

      # Step 2: Verify artifact was downloaded
      - name: Verify artifact
        shell: pwsh
        run: |
          Write-Host "Verifying downloaded artifact..."

          if (Test-Path ${{ env.ZIP_FILE }}) {
            $zipSize = (Get-Item ${{ env.ZIP_FILE }}).Length / 1MB
            Write-Host "âœ… Artifact found: ${{ env.ZIP_FILE }}"
            Write-Host "ðŸ“¦ Size: $($zipSize.ToString('F2')) MB"
          } else {
            Write-Error "âŒ Artifact not found: ${{ env.ZIP_FILE }}"
            exit 1
          }

      # ========================================================================
      # STEP 1: AUTHENTICATION - Get OAuth 2.0 Access Token
      # ========================================================================
      - name: "Step 1: Authenticate with ODC"
        id: auth
        shell: pwsh
        run: |
          $stepStart = Get-Date
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          Write-Host "STEP 1: AUTHENTICATION"
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          try {
            # Get OIDC Discovery document
            $discoveryUrl = "${{ secrets.ODC_PORTAL_URL }}/identity/.well-known/openid-configuration"
            Write-Host "ðŸ” Fetching OIDC Discovery: $discoveryUrl"

            $discovery = Invoke-RestMethod -Uri $discoveryUrl -Method Get
            $tokenEndpoint = $discovery.token_endpoint

            if ([string]::IsNullOrEmpty($tokenEndpoint)) {
              throw "Failed to get token endpoint from OIDC Discovery"
            }

            Write-Host "âœ… Token endpoint: $tokenEndpoint"

            # Request access token
            $body = @{
              grant_type    = "client_credentials"
              client_id     = "${{ secrets.ODC_CLIENT_ID }}"
              client_secret = "${{ secrets.ODC_CLIENT_SECRET }}"
            }

            Write-Host "ðŸ” Requesting access token..."
            $response = Invoke-RestMethod -Uri $tokenEndpoint -Method Post -Body $body -ContentType "application/x-www-form-urlencoded"

            $accessToken = $response.access_token
            if ([string]::IsNullOrEmpty($accessToken)) {
              throw "Empty access token received"
            }

            # Save and mask token
            "ACCESS_TOKEN=$accessToken" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            Write-Host "::add-mask::$accessToken"

            $stepDuration = (Get-Date) - $stepStart
            Write-Host "âœ… Authentication successful (Token expires in: $($response.expires_in)s)"
            Write-Host "â±ï¸  Step 1 completed in $($stepDuration.TotalSeconds.ToString('F2'))s"
            Write-Host ""

          } catch {
            Write-Error "âŒ Step 1 failed: $($_.Exception.Message)"
            if ($_.Exception.Response) {
              $reader = [System.IO.StreamReader]::new($_.Exception.Response.GetResponseStream())
              Write-Host "Error details: $($reader.ReadToEnd())"
            }
            exit 1
          }

      # ========================================================================
      # STEP 2: Get Pre-signed Upload URL
      # ========================================================================
      - name: "Step 2: Get Upload URL"
        id: upload_url
        shell: pwsh
        env:
          ACCESS_TOKEN: ${{ steps.auth.outputs.ACCESS_TOKEN }}
        run: |
          $stepStart = Get-Date
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          Write-Host "STEP 2: GET PRE-SIGNED UPLOAD URL"
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          try {
            $apiUrl = "${{ secrets.ODC_PORTAL_URL }}/api/external-libraries/v1/uploads"
            Write-Host "ðŸ“¡ POST $apiUrl"

            $headers = @{
              "Authorization" = "Bearer $env:ACCESS_TOKEN"
              "Content-Type" = "application/json"
            }

            $response = Invoke-RestMethod -Uri $apiUrl -Method Post -Headers $headers

            $uploadUrl = $response.uploadUrl
            $downloadUrl = $response.downloadUrl

            if ([string]::IsNullOrEmpty($uploadUrl) -or [string]::IsNullOrEmpty($downloadUrl)) {
              throw "Missing uploadUrl or downloadUrl in response"
            }

            # Save URLs to outputs
            "UPLOAD_URL=$uploadUrl" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            "DOWNLOAD_URL=$downloadUrl" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

            # Mask S3 URLs in logs
            Write-Host "::add-mask::$uploadUrl"
            Write-Host "::add-mask::$downloadUrl"

            $stepDuration = (Get-Date) - $stepStart
            Write-Host "âœ… Pre-signed URLs obtained"
            Write-Host "â±ï¸  Step 2 completed in $($stepDuration.TotalSeconds.ToString('F2'))s"
            Write-Host ""

          } catch {
            Write-Error "âŒ Step 2 failed: $($_.Exception.Message)"
            if ($_.Exception.Response) {
              $reader = [System.IO.StreamReader]::new($_.Exception.Response.GetResponseStream())
              Write-Host "Error details: $($reader.ReadToEnd())"
            }
            exit 1
          }

      # ========================================================================
      # STEP 3: Upload ZIP to S3
      # ========================================================================
      - name: "Step 3: Upload ZIP to S3"
        shell: pwsh
        env:
          UPLOAD_URL: ${{ steps.upload_url.outputs.UPLOAD_URL }}
        run: |
          $stepStart = Get-Date
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          Write-Host "STEP 3: UPLOAD ZIP TO S3"
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          try {
            $zipPath = Resolve-Path ${{ env.ZIP_FILE }}
            $zipBytes = [System.IO.File]::ReadAllBytes($zipPath)
            $zipSizeMB = $zipBytes.Length / 1MB

            Write-Host "ðŸ“¦ File: ${{ env.ZIP_FILE }}"
            Write-Host "ðŸ“ Size: $($zipSizeMB.ToString('F2')) MB"
            Write-Host "ðŸš€ Uploading to S3..."

            $headers = @{
              "Content-Type" = "application/zip"
            }

            Invoke-RestMethod -Uri $env:UPLOAD_URL -Method Put -Headers $headers -Body $zipBytes | Out-Null

            $stepDuration = (Get-Date) - $stepStart
            Write-Host "âœ… ZIP uploaded successfully"
            Write-Host "â±ï¸  Step 3 completed in $($stepDuration.TotalSeconds.ToString('F2'))s"
            Write-Host ""

          } catch {
            Write-Error "âŒ Step 3 failed: $($_.Exception.Message)"
            exit 1
          }

      # ========================================================================
      # STEP 4: Create Generation Operation
      # ========================================================================
      - name: "Step 4: Create Generation Operation"
        id: generation
        shell: pwsh
        env:
          ACCESS_TOKEN: ${{ steps.auth.outputs.ACCESS_TOKEN }}
          DOWNLOAD_URL: ${{ steps.upload_url.outputs.DOWNLOAD_URL }}
        run: |
          $stepStart = Get-Date
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          Write-Host "STEP 4: CREATE GENERATION OPERATION"
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          try {
            $apiUrl = "${{ secrets.ODC_PORTAL_URL }}/api/external-libraries/v1/generation-operations"
            Write-Host "ðŸ“¡ POST $apiUrl"

            $headers = @{
              "Authorization" = "Bearer $env:ACCESS_TOKEN"
              "Content-Type" = "application/json"
            }

            $body = @{
              fileName = "${{ env.ZIP_FILE }}"
              highCodeBinaryUri = $env:DOWNLOAD_URL
            } | ConvertTo-Json

            $response = Invoke-RestMethod -Uri $apiUrl -Method Post -Headers $headers -Body $body

            $operationKey = $response.key

            if ([string]::IsNullOrEmpty($operationKey)) {
              throw "Missing operation key in response"
            }

            "OPERATION_KEY=$operationKey" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

            $stepDuration = (Get-Date) - $stepStart
            Write-Host "âœ… Generation operation created"
            Write-Host "ðŸ”‘ Operation Key: $operationKey"
            Write-Host "â±ï¸  Step 4 completed in $($stepDuration.TotalSeconds.ToString('F2'))s"
            Write-Host ""

          } catch {
            Write-Error "âŒ Step 4 failed: $($_.Exception.Message)"
            if ($_.Exception.Response) {
              $reader = [System.IO.StreamReader]::new($_.Exception.Response.GetResponseStream())
              Write-Host "Error details: $($reader.ReadToEnd())"
            }
            exit 1
          }

      # ========================================================================
      # STEP 5: Poll for Generation Completion
      # ========================================================================
      - name: "Step 5: Wait for Generation"
        id: poll
        shell: pwsh
        env:
          ACCESS_TOKEN: ${{ steps.auth.outputs.ACCESS_TOKEN }}
          OPERATION_KEY: ${{ steps.generation.outputs.OPERATION_KEY }}
        run: |
          $stepStart = Get-Date
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          Write-Host "STEP 5: POLL FOR GENERATION COMPLETION"
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          try {
            $apiUrl = "${{ secrets.ODC_PORTAL_URL }}/api/external-libraries/v1/generation-operations/$env:OPERATION_KEY"
            $headers = @{
              "Authorization" = "Bearer $env:ACCESS_TOKEN"
            }

            $maxAttempts = 36  # 36 * 5s = 3 minutes
            $attempt = 0
            $status = ""

            Write-Host "â³ Polling for completion (max 3 minutes)..."

            while ($attempt -lt $maxAttempts) {
              $attempt++
              Write-Host "[$attempt/$maxAttempts] Checking status..."

              $response = Invoke-RestMethod -Uri $apiUrl -Method Get -Headers $headers
              $status = $response.status

              Write-Host "Status: $status"

              if ($status -eq "ReadyForReview") {
                $libraryKey = $response.libraryKey
                $libraryName = $response.libraryName

                if ([string]::IsNullOrEmpty($libraryKey)) {
                  throw "Missing libraryKey in response"
                }

                "LIBRARY_KEY=$libraryKey" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
                "LIBRARY_NAME=$libraryName" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

                $stepDuration = (Get-Date) - $stepStart
                Write-Host ""
                Write-Host "âœ… Generation completed successfully!"
                Write-Host "ðŸ”‘ Library Key: $libraryKey"
                Write-Host "ðŸ“š Library Name: $libraryName"
                Write-Host "â±ï¸  Step 5 completed in $($stepDuration.TotalSeconds.ToString('F2'))s"
                Write-Host ""
                exit 0
              }

              if ($status -eq "Failed" -or $status -eq "Error") {
                throw "Generation failed with status: $status"
              }

              Start-Sleep -Seconds 5
            }

            throw "Timeout waiting for generation (status: $status)"

          } catch {
            Write-Error "âŒ Step 5 failed: $($_.Exception.Message)"
            if ($_.Exception.Response) {
              $reader = [System.IO.StreamReader]::new($_.Exception.Response.GetResponseStream())
              Write-Host "Error details: $($reader.ReadToEnd())"
            }
            exit 1
          }

      # ========================================================================
      # STEP 6: Create Release
      # ========================================================================
      - name: "Step 6: Create Release"
        id: release
        shell: pwsh
        env:
          ACCESS_TOKEN: ${{ steps.auth.outputs.ACCESS_TOKEN }}
          LIBRARY_KEY: ${{ steps.poll.outputs.LIBRARY_KEY }}
        run: |
          $stepStart = Get-Date
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          Write-Host "STEP 6: CREATE RELEASE"
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          try {
            $apiUrl = "${{ secrets.ODC_PORTAL_URL }}/api/asset-management/v1/assets/$env:LIBRARY_KEY/releases"
            Write-Host "ðŸ“¡ POST $apiUrl"

            $headers = @{
              "Authorization" = "Bearer $env:ACCESS_TOKEN"
              "Content-Type" = "application/json"
            }

            $body = @{
              versionNumber = "0.1.${{ github.run_number }}"
              releaseNotes = "Automated deployment from GitHub Actions (Run #${{ github.run_number }})"
            } | ConvertTo-Json

            $response = Invoke-RestMethod -Uri $apiUrl -Method Post -Headers $headers -Body $body

            $releaseKey = $response.releaseKey

            if ([string]::IsNullOrEmpty($releaseKey)) {
              throw "Missing releaseKey in response"
            }

            "RELEASE_KEY=$releaseKey" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

            $stepDuration = (Get-Date) - $stepStart
            Write-Host "âœ… Release created successfully"
            Write-Host "ðŸ”‘ Release Key: $releaseKey"
            Write-Host "ðŸ“Œ Version: 0.1.${{ github.run_number }}"
            Write-Host "â±ï¸  Step 6 completed in $($stepDuration.TotalSeconds.ToString('F2'))s"
            Write-Host ""

          } catch {
            Write-Error "âŒ Step 6 failed: $($_.Exception.Message)"
            if ($_.Exception.Response) {
              $reader = [System.IO.StreamReader]::new($_.Exception.Response.GetResponseStream())
              Write-Host "Error details: $($reader.ReadToEnd())"
            }
            exit 1
          }

      # ========================================================================
      # STEP 7: Publish to Development
      # ========================================================================
      - name: "Step 7: Deploy to Development"
        id: deploy
        shell: pwsh
        env:
          ACCESS_TOKEN: ${{ steps.auth.outputs.ACCESS_TOKEN }}
          LIBRARY_KEY: ${{ steps.poll.outputs.LIBRARY_KEY }}
          RELEASE_KEY: ${{ steps.release.outputs.RELEASE_KEY }}
        run: |
          $stepStart = Get-Date
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          Write-Host "STEP 7: DEPLOY TO DEVELOPMENT"
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          try {
            $apiUrl = "${{ secrets.ODC_PORTAL_URL }}/api/asset-management/v1/assets/$env:LIBRARY_KEY/releases/$env:RELEASE_KEY/deployments"
            Write-Host "ðŸ“¡ POST $apiUrl"

            $headers = @{
              "Authorization" = "Bearer $env:ACCESS_TOKEN"
              "Content-Type" = "application/json"
            }

            $body = @{
              targetStage = "Development"
            } | ConvertTo-Json

            $response = Invoke-RestMethod -Uri $apiUrl -Method Post -Headers $headers -Body $body

            $stepDuration = (Get-Date) - $stepStart
            Write-Host "âœ… Deployed to Development successfully"
            Write-Host "â±ï¸  Step 7 completed in $($stepDuration.TotalSeconds.ToString('F2'))s"
            Write-Host ""
            Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            Write-Host "ðŸŽ‰ DEPLOYMENT COMPLETE!"
            Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          } catch {
            Write-Error "âŒ Step 7 failed: $($_.Exception.Message)"
            if ($_.Exception.Response) {
              $reader = [System.IO.StreamReader]::new($_.Exception.Response.GetResponseStream())
              Write-Host "Error details: $($reader.ReadToEnd())"
            }
            exit 1
          }

      # ========================================================================
      # SUCCESS SUMMARY
      # ========================================================================
      - name: Deployment Summary
        if: success()
        shell: pwsh
        env:
          LIBRARY_NAME: ${{ steps.poll.outputs.LIBRARY_NAME }}
          LIBRARY_KEY: ${{ steps.poll.outputs.LIBRARY_KEY }}
          RELEASE_KEY: ${{ steps.release.outputs.RELEASE_KEY }}
        run: |
          Write-Output "## ðŸŽ‰ Deployment Successful" >> $env:GITHUB_STEP_SUMMARY
          Write-Output "" >> $env:GITHUB_STEP_SUMMARY
          Write-Output "### Library Information" >> $env:GITHUB_STEP_SUMMARY
          Write-Output "- **Name:** $env:LIBRARY_NAME" >> $env:GITHUB_STEP_SUMMARY
          Write-Output "- **Library Key:** ``$env:LIBRARY_KEY``" >> $env:GITHUB_STEP_SUMMARY
          Write-Output "- **Release Key:** ``$env:RELEASE_KEY``" >> $env:GITHUB_STEP_SUMMARY
          Write-Output "- **Version:** 0.1.${{ github.run_number }}" >> $env:GITHUB_STEP_SUMMARY
          Write-Output "" >> $env:GITHUB_STEP_SUMMARY
          Write-Output "### Deployment Details" >> $env:GITHUB_STEP_SUMMARY
          Write-Output "- **Environment:** Development" >> $env:GITHUB_STEP_SUMMARY
          Write-Output "- **Portal:** ${{ secrets.ODC_PORTAL_URL }}" >> $env:GITHUB_STEP_SUMMARY
          Write-Output "- **Deployed:** $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')" >> $env:GITHUB_STEP_SUMMARY
          Write-Output "- **Run:** #${{ github.run_number }}" >> $env:GITHUB_STEP_SUMMARY
          Write-Output "" >> $env:GITHUB_STEP_SUMMARY
          Write-Output "âœ… All 7 deployment steps completed successfully!" >> $env:GITHUB_STEP_SUMMARY

      # ========================================================================
      # FAILURE SUMMARY
      # ========================================================================
      - name: Deployment Failure Summary
        if: failure()
        shell: pwsh
        run: |
          Write-Output "## âŒ Deployment Failed" >> $env:GITHUB_STEP_SUMMARY
          Write-Output "" >> $env:GITHUB_STEP_SUMMARY
          Write-Output "The deployment to ODC Development environment failed." >> $env:GITHUB_STEP_SUMMARY
          Write-Output "Please check the logs above for detailed error information." >> $env:GITHUB_STEP_SUMMARY
          Write-Output "" >> $env:GITHUB_STEP_SUMMARY
          Write-Output "### Common Issues" >> $env:GITHUB_STEP_SUMMARY
          Write-Output "- **Step 1:** Invalid credentials or OIDC Discovery failure" >> $env:GITHUB_STEP_SUMMARY
          Write-Output "- **Step 2:** API permissions or endpoint not available" >> $env:GITHUB_STEP_SUMMARY
          Write-Output "- **Step 3:** S3 upload failure or network issues" >> $env:GITHUB_STEP_SUMMARY
          Write-Output "- **Step 4:** Invalid ZIP package or generation request" >> $env:GITHUB_STEP_SUMMARY
          Write-Output "- **Step 5:** Generation timeout or compilation errors" >> $env:GITHUB_STEP_SUMMARY
          Write-Output "- **Step 6:** Release creation failure" >> $env:GITHUB_STEP_SUMMARY
          Write-Output "- **Step 7:** Deployment to stage failure" >> $env:GITHUB_STEP_SUMMARY
